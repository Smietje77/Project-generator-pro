---
import Button from '../ui/Button.astro';
---

<div x-show="activeTab === 'prompt'" x-cloak class="space-y-4">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h3 class="text-lg font-semibold text-gray-900">Generated Project Prompt</h3>
      <p class="text-sm text-gray-600 mt-1">This is the complete prompt that will be saved to PROJECT_PROMPT.md</p>
    </div>
    <div class="flex gap-2">
      <Button
        type="button"
        variant="secondary"
        size="sm"
        id="copy-prompt-preview-btn"
      >
        ðŸ“‹ Copy
      </Button>
      <Button
        type="button"
        variant="secondary"
        size="sm"
        id="download-prompt-btn"
      >
        ðŸ’¾ Download
      </Button>
    </div>
  </div>

  <!-- Prompt Content -->
  <div class="bg-gray-900 text-gray-100 rounded-lg border-2 border-gray-700 overflow-hidden">
    <!-- Table of Contents -->
    <div class="bg-gray-800 px-6 py-3 border-b border-gray-700">
      <details class="cursor-pointer">
        <summary class="text-sm font-semibold text-gray-300 hover:text-white">
          ðŸ“‘ Table of Contents
        </summary>
        <nav id="prompt-toc" class="mt-3 space-y-1 text-xs">
          <!-- Will be populated dynamically -->
        </nav>
      </details>
    </div>

    <!-- Prompt Display -->
    <div class="p-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
      <pre id="prompt-preview-content" class="text-sm whitespace-pre-wrap font-mono leading-relaxed text-gray-100">
Loading prompt preview...
      </pre>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-4 gap-4 text-center">
    <div class="bg-blue-50 rounded-lg p-3">
      <div class="text-2xl font-bold text-blue-900" id="prompt-stat-agents">-</div>
      <div class="text-xs text-blue-700">AI Agents</div>
    </div>
    <div class="bg-green-50 rounded-lg p-3">
      <div class="text-2xl font-bold text-green-900" id="prompt-stat-tasks">-</div>
      <div class="text-xs text-green-700">Tasks</div>
    </div>
    <div class="bg-purple-50 rounded-lg p-3">
      <div class="text-2xl font-bold text-purple-900" id="prompt-stat-mcps">-</div>
      <div class="text-xs text-purple-700">MCP Servers</div>
    </div>
    <div class="bg-orange-50 rounded-lg p-3">
      <div class="text-2xl font-bold text-orange-900" id="prompt-stat-chars">-</div>
      <div class="text-xs text-orange-700">Characters</div>
    </div>
  </div>
</div>

<style>
  .custom-scrollbar::-webkit-scrollbar {
    width: 8px;
  }

  .custom-scrollbar::-webkit-scrollbar-track {
    background: #374151;
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: #6B7280;
    border-radius: 4px;
  }

  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF;
  }

  [x-cloak] {
    display: none !important;
  }
</style>

<script>
  // Prompt preview functionality will be added to main Step3 script
  window.addEventListener('step3:prompt-ready', ((event: CustomEvent) => {
    const { prompt, analysis } = event.detail;

    console.log('[PromptPreview] Received event:', {
      hasPrompt: !!prompt,
      hasAnalysis: !!analysis,
      analysisKeys: analysis ? Object.keys(analysis) : []
    });

    // Display prompt
    const promptContent = document.getElementById('prompt-preview-content');
    if (promptContent && prompt) {
      promptContent.textContent = prompt;
    }

    // Update stats
    if (analysis) {
      const agentsStat = document.getElementById('prompt-stat-agents');
      const tasksStat = document.getElementById('prompt-stat-tasks');
      const mcpsStat = document.getElementById('prompt-stat-mcps');
      const charsStat = document.getElementById('prompt-stat-chars');

      // Try multiple possible property names for compatibility
      if (agentsStat) {
        const agentsCount = analysis.totalAgents || analysis.requiredAgents?.length || analysis.agents?.length || '-';
        agentsStat.textContent = agentsCount;
        console.log('[PromptPreview] Agents count:', agentsCount);
      }
      if (tasksStat) {
        const tasksCount = analysis.totalTasks || analysis.taskBreakdown?.length || analysis.tasks?.length || '-';
        tasksStat.textContent = tasksCount;
        console.log('[PromptPreview] Tasks count:', tasksCount);
      }
      if (mcpsStat) {
        const mcpsCount = analysis.totalMCPs || analysis.recommendedMCPs?.length || analysis.mcps?.length || '-';
        mcpsStat.textContent = mcpsCount;
        console.log('[PromptPreview] MCPs count:', mcpsCount);
      }
      if (charsStat && prompt) {
        charsStat.textContent = prompt.length.toLocaleString();
      }
    }

    // Generate Table of Contents
    const toc = document.getElementById('prompt-toc');
    if (toc && prompt) {
      const headings = prompt.match(/^#{1,3}\s+.+$/gm) || [];
      toc.innerHTML = headings.slice(0, 10).map(heading => {
        const level = heading.match(/^#+/)?.[0].length || 1;
        const text = heading.replace(/^#+\s+/, '');
        const indent = (level - 1) * 12;
        return `<div style="padding-left: ${indent}px" class="text-gray-400 hover:text-white cursor-pointer truncate">â€¢ ${text}</div>`;
      }).join('');
    }
  }) as EventListener);

  // Copy to clipboard
  document.getElementById('copy-prompt-preview-btn')?.addEventListener('click', async () => {
    const promptContent = document.getElementById('prompt-preview-content');
    if (promptContent) {
      try {
        await navigator.clipboard.writeText(promptContent.textContent || '');
        const btn = document.getElementById('copy-prompt-preview-btn');
        const originalText = btn?.textContent;
        if (btn) {
          btn.textContent = 'âœ“ Copied!';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        }
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }
  });

  // Download as file
  document.getElementById('download-prompt-btn')?.addEventListener('click', () => {
    const promptContent = document.getElementById('prompt-preview-content');
    if (promptContent) {
      const blob = new Blob([promptContent.textContent || ''], { type: 'text/markdown' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'PROJECT_PROMPT.md';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }
  });
</script>
