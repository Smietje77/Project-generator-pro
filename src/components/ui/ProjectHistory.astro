---
/**
 * Project History Component
 * Displays recent projects with quick actions
 */
---

<div id="project-history-section" class="mb-8">
  <div class="bg-white border-2 border-gray-200 rounded-lg overflow-hidden">
    <!-- Collapsible Header -->
    <button
      id="history-toggle-btn"
      class="w-full flex items-center justify-between p-6 hover:bg-gray-50 transition text-left"
    >
      <div class="flex items-center gap-3">
        <span class="text-2xl">üìö</span>
        <div>
          <h3 class="text-lg font-bold text-gray-900">Recent Projects</h3>
          <p class="text-sm text-gray-600 mt-0.5">Continue where you left off or start a similar project</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <span id="history-count-badge" class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-1 rounded-full">0</span>
        <svg id="history-chevron" class="h-5 w-5 text-gray-400 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </button>

    <!-- Collapsible Content -->
    <div id="history-content" class="hidden border-t-2 border-gray-200">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <div class="text-sm text-gray-600">
            Click on a project to load it into the wizard
          </div>
          <button
            id="clear-history-btn"
            class="text-sm text-gray-500 hover:text-red-600 transition"
          >
            Clear All
          </button>
        </div>

        <!-- History Stats -->
        <div id="history-stats" class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-3 text-center">
            <div class="text-2xl font-bold text-blue-900" id="stat-total">0</div>
            <div class="text-xs text-blue-700">Total Projects</div>
          </div>
          <div class="bg-green-50 rounded-lg p-3 text-center">
            <div class="text-2xl font-bold text-green-900" id="stat-templates">0</div>
            <div class="text-xs text-green-700">From Templates</div>
          </div>
          <div class="bg-purple-50 rounded-lg p-3 text-center">
            <div class="text-2xl font-bold text-purple-900" id="stat-week">0</div>
            <div class="text-xs text-purple-700">This Week</div>
          </div>
        </div>

        <!-- Empty State -->
        <div id="history-empty" class="text-center py-8 text-gray-500">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
          <p class="text-sm font-medium">No projects yet</p>
          <p class="text-xs mt-1">Your generated projects will appear here</p>
        </div>

        <!-- History List -->
        <div id="history-list" class="space-y-3 hidden max-h-96 overflow-y-auto">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { getProjectHistory, getHistoryStats, removeFromHistory, clearHistory, loadProjectIntoWizard } from '../../lib/projectHistory';
  import { showSuccess, showWarning, showInfo } from '../../lib/notifications';

  function renderHistory() {
    const historyList = document.getElementById('history-list');
    const emptyState = document.getElementById('history-empty');
    const history = getProjectHistory();

    if (history.length === 0) {
      historyList?.classList.add('hidden');
      emptyState?.classList.remove('hidden');
      return;
    }

    historyList?.classList.remove('hidden');
    emptyState?.classList.add('hidden');

    historyList!.innerHTML = history.map(project => {
      const date = new Date(project.createdAt);
      const timeAgo = getTimeAgo(date);
      const isTemplate = !!project.templateId;

      return `
        <div class="group border-2 border-gray-200 rounded-lg p-4 hover:border-indigo-300 hover:shadow-md transition-all" data-project-id="${project.id}">
          <div class="flex items-start justify-between gap-4">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <h4 class="font-semibold text-gray-900 truncate">${escapeHtml(project.projectName)}</h4>
                ${isTemplate ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 text-indigo-800">‚ö° Template</span>` : ''}
              </div>
              <p class="text-sm text-gray-600 line-clamp-2 mb-2">${escapeHtml(project.description)}</p>
              <div class="flex items-center gap-3 text-xs text-gray-500">
                <span class="flex items-center gap-1">
                  <svg class="h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                  </svg>
                  ${timeAgo}
                </span>
                ${project.projectPath ? `<span class="truncate max-w-xs" title="${escapeHtml(project.projectPath)}">üìÅ ${escapeHtml(project.sanitizedName || project.projectName)}</span>` : ''}
              </div>
            </div>
            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button
                class="load-project-btn p-2 text-indigo-600 hover:bg-indigo-50 rounded transition"
                data-project-id="${project.id}"
                title="Load this project"
              >
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
              </button>
              <button
                class="delete-project-btn p-2 text-red-600 hover:bg-red-50 rounded transition"
                data-project-id="${project.id}"
                title="Remove from history"
              >
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');

    // Attach event listeners
    document.querySelectorAll('.load-project-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const projectId = (e.currentTarget as HTMLElement).dataset.projectId;
        if (projectId) handleLoadProject(projectId);
      });
    });

    document.querySelectorAll('.delete-project-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const projectId = (e.currentTarget as HTMLElement).dataset.projectId;
        if (projectId) handleDeleteProject(projectId);
      });
    });
  }

  function renderStats() {
    const stats = getHistoryStats();
    const totalEl = document.getElementById('stat-total');
    const templatesEl = document.getElementById('stat-templates');
    const weekEl = document.getElementById('stat-week');
    const countBadge = document.getElementById('history-count-badge');

    if (totalEl) totalEl.textContent = stats.total.toString();
    if (templatesEl) templatesEl.textContent = stats.templates.toString();
    if (weekEl) weekEl.textContent = stats.lastWeek.toString();
    if (countBadge) countBadge.textContent = stats.total.toString();
  }

  function handleLoadProject(projectId: string) {
    const history = getProjectHistory();
    const project = history.find(p => p.id === projectId);

    if (!project) {
      showWarning('Project not found in history');
      return;
    }

    console.log('[ProjectHistory] Loading project:', project);

    loadProjectIntoWizard(project);

    // Dispatch event to trigger wizard reload
    window.dispatchEvent(new CustomEvent('project:loaded', { detail: project }));

    showSuccess(`Loaded "${project.projectName}" into wizard`, { duration: 3000 });

    // Scroll to top and close history
    const historyContent = document.getElementById('history-content');
    const chevron = document.getElementById('history-chevron');

    historyContent?.classList.add('hidden');
    chevron?.classList.remove('rotate-180');

    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function handleDeleteProject(projectId: string) {
    const history = getProjectHistory();
    const project = history.find(p => p.id === projectId);

    if (!project) return;

    if (confirm(`Remove "${project.projectName}" from history?`)) {
      removeFromHistory(projectId);
      showInfo('Project removed from history', { duration: 2000 });
    }
  }

  function handleClearAll() {
    if (confirm('Clear all project history? This cannot be undone.')) {
      clearHistory();
      showInfo('Project history cleared', { duration: 2000 });
    }
  }

  function getTimeAgo(date: Date): string {
    const seconds = Math.floor((new Date().getTime() - date.getTime()) / 1000);

    let interval = seconds / 31536000;
    if (interval > 1) return Math.floor(interval) + ' years ago';

    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + ' months ago';

    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + ' days ago';

    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + ' hours ago';

    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + ' minutes ago';

    return 'Just now';
  }

  function escapeHtml(unsafe: string): string {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // Initial render
  renderHistory();
  renderStats();

  // Listen for history updates
  window.addEventListener('project-history:updated', () => {
    renderHistory();
    renderStats();
  });

  // Clear all button
  document.getElementById('clear-history-btn')?.addEventListener('click', handleClearAll);

  // Toggle collapse
  const toggleBtn = document.getElementById('history-toggle-btn');
  const historyContent = document.getElementById('history-content');
  const chevron = document.getElementById('history-chevron');

  toggleBtn?.addEventListener('click', () => {
    const isHidden = historyContent?.classList.contains('hidden');

    if (isHidden) {
      historyContent?.classList.remove('hidden');
      chevron?.classList.add('rotate-180');
    } else {
      historyContent?.classList.add('hidden');
      chevron?.classList.remove('rotate-180');
    }
  });
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
