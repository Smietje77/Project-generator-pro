---
import Card from './ui/Card.astro';
import Select from './ui/Select.astro';
import Textarea from './ui/Textarea.astro';
import Button from './ui/Button.astro';

const features = [
  { id: 'auth', label: 'Authentication', icon: 'üîê', description: 'User login, registration, password reset' },
  { id: 'database', label: 'Database', icon: 'üóÑÔ∏è', description: 'Data persistence and queries' },
  { id: 'api', label: 'API Routes', icon: '‚ö°', description: 'RESTful or GraphQL endpoints' },
  { id: 'upload', label: 'File Upload', icon: 'üìÅ', description: 'Image and file handling' },
  { id: 'email', label: 'Email Service', icon: 'üìß', description: 'Transactional emails' },
  { id: 'payment', label: 'Payment Integration', icon: 'üí≥', description: 'Stripe, PayPal, etc.' },
  { id: 'analytics', label: 'Analytics', icon: 'üìä', description: 'User tracking and insights' },
  { id: 'testing', label: 'Testing Setup', icon: 'üß™', description: 'Unit and E2E tests' },
];

const frontendOptions = [
  { value: 'react', label: 'React' },
  { value: 'vue', label: 'Vue.js' },
  { value: 'astro', label: 'Astro' },
  { value: 'svelte', label: 'Svelte' },
  { value: 'next', label: 'Next.js' },
];

const backendOptions = [
  { value: 'node', label: 'Node.js' },
  { value: 'bun', label: 'Bun' },
  { value: 'python', label: 'Python' },
  { value: 'go', label: 'Go' },
  { value: 'none', label: 'Static/No Backend' },
];

const databaseOptions = [
  { value: 'postgresql', label: 'PostgreSQL' },
  { value: 'mysql', label: 'MySQL' },
  { value: 'mongodb', label: 'MongoDB' },
  { value: 'supabase', label: 'Supabase' },
  { value: 'none', label: 'No Database' },
];
---

<Card title="Step 3: Features & Tech Stack" description="Select the features and technologies you need">
  <form id="step2-form" class="space-y-8">

    <!-- AI Suggestions Section -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-lg p-4">
      <div class="flex items-start justify-between gap-4">
        <div class="flex-1">
          <h3 class="text-sm font-semibold text-indigo-900 flex items-center gap-2">
            <span class="text-xl">‚ú®</span>
            AI-Powered Suggestions
          </h3>
          <p class="text-sm text-indigo-700 mt-1">
            Let AI analyze your project and suggest the best features and tech stack
          </p>
        </div>
        <Button
          type="button"
          variant="primary"
          id="generate-ai-suggestions-btn"
          class="flex-shrink-0"
        >
          Generate Suggestions
        </Button>
      </div>

      <!-- AI Reasoning Box (hidden initially) -->
      <div id="ai-reasoning-box" class="hidden mt-4 p-3 bg-white border border-indigo-300 rounded-lg">
        <h4 class="text-xs font-semibold text-indigo-900 mb-2">AI Recommendation:</h4>
        <p id="ai-reasoning-text" class="text-sm text-gray-700"></p>
      </div>

      <!-- Loading State -->
      <div id="ai-loading" class="hidden mt-4 flex items-center gap-2 text-indigo-700">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
          <circle class="opacity-75" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none" stroke-dasharray="32" stroke-dashoffset="16"></circle>
        </svg>
        <span class="text-sm font-medium">Analyzing your project with AI...</span>
      </div>
    </div>

    <!-- Features Selection -->
    <div class="space-y-4">
      <label class="block text-sm font-medium text-gray-700">
        Required Features
      </label>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {features.map((feature) => (
          <label class="relative flex items-start p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary-400 transition-colors">
            <input
              type="checkbox"
              name="features"
              value={feature.id}
              class="mt-1 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"
            />
            <div class="ml-3 flex-1">
              <div class="flex items-center gap-2">
                <span class="text-xl" aria-hidden="true">{feature.icon}</span>
                <span class="font-medium text-gray-900">{feature.label}</span>
              </div>
              <p class="text-sm text-gray-500 mt-1">{feature.description}</p>
            </div>
          </label>
        ))}
      </div>
    </div>

    <!-- Tech Stack -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <Select
        name="frontend"
        label="Frontend Framework"
        options={frontendOptions}
        placeholder="Select frontend..."
        required
      />

      <Select
        name="backend"
        label="Backend Runtime"
        options={backendOptions}
        placeholder="Select backend..."
        required
      />

      <Select
        name="database"
        label="Database"
        options={databaseOptions}
        placeholder="Select database..."
        required
      />
    </div>

    <!-- Additional Requirements -->
    <Textarea
      name="additionalRequirements"
      label="Additional Requirements (Optional)"
      placeholder="Any specific libraries, patterns, or requirements we should know about..."
      rows={4}
    />

    <!-- Advanced Options -->
    <details class="border-2 border-gray-200 rounded-lg p-4 hover:border-gray-300 transition-colors">
      <summary class="cursor-pointer font-medium text-gray-700 hover:text-gray-900 flex items-center gap-2">
        <span>‚öôÔ∏è</span>
        <span>Advanced Options</span>
      </summary>
      <div class="mt-4 space-y-4">
        <Select
          name="estimatedComplexity"
          label="Project Complexity"
          options={[
            { value: 'simple', label: 'üü¢ Simple - Small projects, POCs (5-6 agents)' },
            { value: 'moderate', label: 'üü° Moderate - Standard web apps (7-8 agents)' },
            { value: 'complex', label: 'üü† Complex - Enterprise apps (8-9 agents)' },
            { value: 'enterprise', label: 'üî¥ Enterprise - Large systems (9+ agents)' }
          ]}
          value="moderate"
        />
        <p class="text-xs text-gray-500 italic">
          üí° Complexity determines the number of AI agents, depth of analysis, and recommended tools. Simple projects get essential agents only, while Enterprise projects include specialized research and optimization agents.
        </p>
      </div>
    </details>

    <!-- Navigation Buttons -->
    <div class="flex justify-between pt-6">
      <Button
        type="button"
        variant="secondary"
        data-action="previous"
      >
        ‚Üê Previous
      </Button>

      <Button
        type="submit"
        variant="primary"
      >
        Next Step ‚Üí
      </Button>
    </div>
  </form>
</Card>

<script>
  import { showError, showSuccess, showWarning, showInfo } from '../lib/notifications';
  import { createButtonState } from '../lib/buttonState';

  // Form validation and navigation
  const form = document.getElementById('step2-form') as HTMLFormElement;
  const aiBtn = document.getElementById('generate-ai-suggestions-btn') as HTMLButtonElement;
  const aiLoading = document.getElementById('ai-loading');
  const aiReasoningBox = document.getElementById('ai-reasoning-box');
  const aiReasoningText = document.getElementById('ai-reasoning-text');

  // Create button state manager
  const aiBtnState = createButtonState(aiBtn, 'Generate Suggestions');

  // AI Suggestions Handler
  if (aiBtn) {
    aiBtn.addEventListener('click', async () => {
      try {
        // Get Step 1 data
        const step1Data = JSON.parse(sessionStorage.getItem('step1Data') || '{}');

        if (!step1Data.projectName || !step1Data.description) {
          showWarning('Please complete Step 1 first before generating AI suggestions.');
          return;
        }

        // Show loading state
        aiBtnState.setLoading('Analyzing with AI...');
        aiLoading?.classList.remove('hidden');
        aiReasoningBox?.classList.add('hidden');
        showInfo('AI is analyzing your project description...', { duration: 3000 });

        // Get discovery data if available
        const discoveryDataStr = sessionStorage.getItem('aiDiscoveryData');
        const discoveryData = discoveryDataStr ? JSON.parse(discoveryDataStr) : null;

        // Call AI API
        const response = await fetch('/api/suggest', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            projectName: step1Data.projectName,
            description: step1Data.description,
            projectType: step1Data.projectType,
            discoveryData
          })
        });

        if (!response.ok) {
          throw new Error('Failed to generate suggestions');
        }

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error || 'Failed to generate suggestions');
        }

        // Apply suggestions to form
        const { features, techStack, reasoning } = result.data;

        console.log('[Step3] AI Suggestions received:', { features, techStack, reasoning });

        // Check feature checkboxes
        if (features && Array.isArray(features)) {
          // First uncheck all
          const allCheckboxes = form.querySelectorAll('input[name="features"]') as NodeListOf<HTMLInputElement>;
          allCheckboxes.forEach(cb => cb.checked = false);

          console.log('[Step3] Applying features:', features);

          // Then check suggested ones
          let appliedCount = 0;
          features.forEach((featureId: string) => {
            const checkbox = form.querySelector(`input[value="${featureId}"]`) as HTMLInputElement;
            if (checkbox) {
              checkbox.checked = true;
              appliedCount++;
              // Add visual feedback
              checkbox.parentElement?.classList.add('border-primary-500', 'bg-primary-50');
              setTimeout(() => {
                checkbox.parentElement?.classList.remove('border-primary-500', 'bg-primary-50');
              }, 1000);
            } else {
              console.warn('[Step3] Feature not found:', featureId);
            }
          });

          console.log('[Step3] Applied', appliedCount, 'of', features.length, 'features');
        }

        // Set tech stack dropdowns
        if (techStack) {
          if (techStack.frontend) {
            const frontendSelect = form.querySelector('select[name="frontend"]') as HTMLSelectElement;
            if (frontendSelect) frontendSelect.value = techStack.frontend;
          }
          if (techStack.backend) {
            const backendSelect = form.querySelector('select[name="backend"]') as HTMLSelectElement;
            if (backendSelect) backendSelect.value = techStack.backend;
          }
          if (techStack.database) {
            const databaseSelect = form.querySelector('select[name="database"]') as HTMLSelectElement;
            if (databaseSelect) databaseSelect.value = techStack.database;
          }
        }

        // Show reasoning
        if (reasoning && aiReasoningText) {
          aiReasoningText.textContent = reasoning;
          aiReasoningBox?.classList.remove('hidden');
        }

        // Success feedback
        aiBtnState.setSuccess('‚úì Suggestions Applied', 3000);
        showSuccess('AI suggestions applied successfully!', { duration: 4000 });

      } catch (error) {
        console.error('[AI Suggest] Error:', error);
        showError('Failed to generate AI suggestions. Please try selecting features and tech stack manually.');
        aiBtnState.setError('Try Again', 3000);
      } finally {
        aiLoading?.classList.add('hidden');
      }
    });
  }

  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // Get form data
      const formData = new FormData(form);
      const features = formData.getAll('features');
      const frontend = formData.get('frontend');
      const backend = formData.get('backend');
      const database = formData.get('database');
      const additionalRequirements = formData.get('additionalRequirements');

      // Store in sessionStorage for next step
      sessionStorage.setItem('step2Data', JSON.stringify({
        features,
        techStack: {
          frontend,
          backend,
          database
        },
        additionalRequirements,
        estimatedComplexity: formData.get('estimatedComplexity') || 'moderate'
      }));

      // Dispatch event to parent to move to next step
      window.dispatchEvent(new CustomEvent('wizard:next'));
    });

    // Previous button handler
    const prevButton = form.querySelector('[data-action="previous"]');
    if (prevButton) {
      prevButton.addEventListener('click', () => {
        window.dispatchEvent(new CustomEvent('wizard:previous'));
      });
    }

    // Load saved data if exists
    const savedData = sessionStorage.getItem('step2Data');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);

        // Restore features checkboxes
        if (data.features) {
          data.features.forEach((featureId: string) => {
            const checkbox = form.querySelector(`input[value="${featureId}"]`) as HTMLInputElement;
            if (checkbox) checkbox.checked = true;
          });
        }

        // Restore selects
        if (data.techStack) {
          (form.querySelector('select[name="frontend"]') as HTMLSelectElement).value = data.techStack.frontend || '';
          (form.querySelector('select[name="backend"]') as HTMLSelectElement).value = data.techStack.backend || '';
          (form.querySelector('select[name="database"]') as HTMLSelectElement).value = data.techStack.database || '';
        }

        // Restore textarea
        if (data.additionalRequirements) {
          (form.querySelector('textarea[name="additionalRequirements"]') as HTMLTextAreaElement).value = data.additionalRequirements;
        }

        // Restore complexity
        if (data.estimatedComplexity) {
          (form.querySelector('select[name="estimatedComplexity"]') as HTMLSelectElement).value = data.estimatedComplexity;
        }
      } catch (error) {
        console.error('Error loading saved data:', error);
      }
    }
  }
</script>
