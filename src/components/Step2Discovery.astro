---
import Card from './ui/Card.astro';
import Button from './ui/Button.astro';
---

<Card title="Step 2: AI Discovery Interview" description="Answer a few questions to help us understand your project better">
  <!-- Loading State -->
  <div id="questions-loading" class="flex flex-col items-center justify-center py-12">
    <svg class="animate-spin h-12 w-12 text-indigo-600 mb-4" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-lg font-medium text-gray-700">AI is analyzing your project...</p>
    <p class="text-sm text-gray-500 mt-2">Generating intelligent questions to improve your project</p>
  </div>

  <!-- Error State -->
  <div id="questions-error" class="hidden">
    <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6 text-center">
      <div class="text-4xl mb-3">‚ö†Ô∏è</div>
      <h3 class="text-lg font-semibold text-red-900 mb-2">Failed to Generate Questions</h3>
      <p class="text-sm text-red-700 mb-4" id="error-message">Something went wrong. Please try again or skip this step.</p>
      <div class="flex gap-3 justify-center">
        <Button type="button" variant="primary" id="retry-questions-btn">
          Try Again
        </Button>
        <Button type="button" variant="secondary" data-action="skip">
          Skip Interview
        </Button>
      </div>
    </div>
  </div>

  <!-- Questions Form -->
  <form id="discovery-form" class="hidden space-y-6">
    <!-- AI Reasoning Box -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 border-indigo-200 rounded-lg p-4">
      <div class="flex items-start gap-3">
        <span class="text-2xl">ü§ñ</span>
        <div>
          <h3 class="text-sm font-semibold text-indigo-900 mb-1">Why these questions?</h3>
          <p class="text-sm text-indigo-700" id="ai-reasoning"></p>
        </div>
      </div>
    </div>

    <!-- Progress Indicator -->
    <div class="bg-gray-100 rounded-lg p-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-sm font-medium text-gray-700">Progress</span>
        <span class="text-sm font-medium text-gray-700" id="progress-text">0 / 0 answered</span>
      </div>
      <div class="w-full bg-gray-300 rounded-full h-2">
        <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
    </div>

    <!-- Questions Container -->
    <div id="questions-container" class="space-y-6">
      <!-- Questions will be dynamically inserted here -->
    </div>

    <!-- Navigation Buttons -->
    <div class="flex justify-between pt-6">
      <Button
        type="button"
        variant="secondary"
        data-action="previous"
      >
        ‚Üê Previous
      </Button>

      <div class="flex gap-3">
        <Button
          type="button"
          variant="secondary"
          data-action="skip"
        >
          Skip Interview
        </Button>

        <Button
          type="submit"
          variant="primary"
          id="submit-discovery-btn"
        >
          Continue ‚Üí
        </Button>
      </div>
    </div>
  </form>
</Card>

<script>
  import { showError, showSuccess, showWarning, showInfo } from '../lib/notifications';
  import { createButtonState } from '../lib/buttonState';

  // Elements
  const loadingState = document.getElementById('questions-loading');
  const errorState = document.getElementById('questions-error');
  const errorMessage = document.getElementById('error-message');
  const form = document.getElementById('discovery-form') as HTMLFormElement;
  const questionsContainer = document.getElementById('questions-container');
  const aiReasoning = document.getElementById('ai-reasoning');
  const progressText = document.getElementById('progress-text');
  const progressBar = document.getElementById('progress-bar');
  const retryBtn = document.getElementById('retry-questions-btn');
  const submitBtn = document.getElementById('submit-discovery-btn');

  // Button state
  const submitBtnState = createButtonState(submitBtn, 'Continue ‚Üí');

  // Store questions data
  let questionsData: any[] = [];
  let answeredCount = 0;

  // Generate questions on load
  async function generateQuestions() {
    try {
      console.log('[Discovery] Starting question generation...');

      // Show loading state
      loadingState?.classList.remove('hidden');
      errorState?.classList.add('hidden');
      form?.classList.add('hidden');

      // Get Step 1 data
      const step1DataStr = sessionStorage.getItem('step1Data');
      console.log('[Discovery] Step1 data:', step1DataStr);

      const step1Data = JSON.parse(step1DataStr || '{}');

      if (!step1Data.projectName || !step1Data.description) {
        throw new Error('Missing project information. Please complete Step 1 first.');
      }

      // Check if we're using a template (skip discovery for templates)
      const templateId = sessionStorage.getItem('templateId');
      if (templateId) {
        console.log('[Discovery] Template detected, skipping discovery interview');
        showInfo('Using template - skipping discovery interview', { duration: 2000 });
        setTimeout(() => {
          window.dispatchEvent(new CustomEvent('wizard:next'));
        }, 500);
        return;
      }

      console.log('[Discovery] Calling /api/generate-questions...', {
        projectName: step1Data.projectName,
        projectType: step1Data.projectType
      });

      // Call API to generate questions
      const response = await fetch('/api/generate-questions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin', // Include cookies for authentication
        body: JSON.stringify({
          projectName: step1Data.projectName,
          description: step1Data.description,
          projectType: step1Data.projectType
        })
      });

      console.log('[Discovery] Response status:', response.status);

      if (!response.ok) {
        throw new Error('Failed to generate questions');
      }

      const result = await response.json();

      if (!result.success) {
        throw new Error(result.error || 'Failed to generate questions');
      }

      // Store questions and display them
      questionsData = result.data.questions;
      displayQuestions(questionsData, result.data.reasoning);

      // Hide loading, show form
      loadingState?.classList.add('hidden');
      form?.classList.remove('hidden');

      showSuccess(`Generated ${questionsData.length} questions to improve your project!`, { duration: 3000 });

    } catch (error) {
      console.error('[Discovery] Error generating questions:', error);

      // Show error state
      loadingState?.classList.add('hidden');
      errorState?.classList.remove('hidden');

      if (errorMessage) {
        errorMessage.textContent = error instanceof Error ? error.message : 'An unexpected error occurred.';
      }

      showError('Failed to generate discovery questions. You can retry or skip this step.');
    }
  }

  // Display questions dynamically
  function displayQuestions(questions: any[], reasoning: string) {
    if (!questionsContainer) return;

    // Set reasoning
    if (aiReasoning) {
      aiReasoning.textContent = reasoning;
    }

    // Clear container
    questionsContainer.innerHTML = '';

    // Create question elements
    questions.forEach((q, index) => {
      const questionDiv = document.createElement('div');
      questionDiv.className = 'question-item bg-white border-2 border-gray-200 rounded-lg p-5 hover:border-indigo-300 transition-colors';
      questionDiv.dataset.questionId = q.id;

      // Category badge
      const categoryColors: Record<string, string> = {
        design: 'bg-purple-100 text-purple-700',
        functionality: 'bg-blue-100 text-blue-700',
        data: 'bg-green-100 text-green-700',
        audience: 'bg-orange-100 text-orange-700',
        technical: 'bg-red-100 text-red-700',
        other: 'bg-gray-100 text-gray-700'
      };

      let questionHTML = `
        <div class="flex items-start justify-between mb-3">
          <label class="block text-sm font-medium text-gray-900">
            ${index + 1}. ${q.question}
            ${q.required ? '<span class="text-red-500 ml-1">*</span>' : ''}
          </label>
          <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${categoryColors[q.category] || categoryColors.other}">
            ${q.category}
          </span>
        </div>
      `;

      // Render based on question type
      switch (q.type) {
        case 'text':
          questionHTML += `
            <input
              type="text"
              name="${q.id}"
              placeholder="${q.placeholder || 'Your answer...'}"
              ${q.required ? 'required' : ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
              data-question-id="${q.id}"
            />
          `;
          break;

        case 'textarea':
          questionHTML += `
            <textarea
              name="${q.id}"
              placeholder="${q.placeholder || 'Describe in detail...'}"
              rows="4"
              ${q.required ? 'required' : ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
              data-question-id="${q.id}"
            ></textarea>
          `;
          break;

        case 'multiple-choice':
          questionHTML += '<div class="space-y-2">';
          q.options?.forEach((option: string, optIndex: number) => {
            questionHTML += `
              <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 transition-colors">
                <input
                  type="radio"
                  name="${q.id}"
                  value="${option}"
                  ${q.required ? 'required' : ''}
                  class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"
                  data-question-id="${q.id}"
                />
                <span class="ml-3 text-sm text-gray-700">${option}</span>
              </label>
            `;
          });
          questionHTML += '</div>';
          break;

        case 'checkboxes':
          questionHTML += '<div class="space-y-2">';
          q.options?.forEach((option: string, optIndex: number) => {
            questionHTML += `
              <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-indigo-300 transition-colors">
                <input
                  type="checkbox"
                  name="${q.id}"
                  value="${option}"
                  class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
                  data-question-id="${q.id}"
                />
                <span class="ml-3 text-sm text-gray-700">${option}</span>
              </label>
            `;
          });
          questionHTML += '</div>';
          break;
      }

      questionDiv.innerHTML = questionHTML;
      questionsContainer.appendChild(questionDiv);
    });

    // Update progress
    updateProgress();

    // Add change listeners to all inputs
    const inputs = questionsContainer.querySelectorAll('input, textarea');
    inputs.forEach(input => {
      input.addEventListener('change', updateProgress);
      input.addEventListener('input', updateProgress);
    });
  }

  // Update progress indicator
  function updateProgress() {
    const totalQuestions = questionsData.length;
    answeredCount = 0;

    questionsData.forEach(q => {
      const inputs = form?.querySelectorAll(`[data-question-id="${q.id}"]`) as NodeListOf<HTMLInputElement | HTMLTextAreaElement>;

      if (q.type === 'checkboxes') {
        // For checkboxes, check if at least one is selected
        const checked = Array.from(inputs).some(input => (input as HTMLInputElement).checked);
        if (checked) answeredCount++;
      } else if (q.type === 'multiple-choice') {
        // For radio buttons, check if one is selected
        const selected = Array.from(inputs).some(input => (input as HTMLInputElement).checked);
        if (selected) answeredCount++;
      } else {
        // For text/textarea, check if value is not empty
        const value = inputs[0]?.value?.trim();
        if (value) answeredCount++;
      }
    });

    // Update UI
    if (progressText) {
      progressText.textContent = `${answeredCount} / ${totalQuestions} answered`;
    }

    if (progressBar) {
      const percentage = totalQuestions > 0 ? (answeredCount / totalQuestions) * 100 : 0;
      progressBar.style.width = `${percentage}%`;
    }
  }

  // Form submission
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // Collect answers
      const formData = new FormData(form);
      const answers: Record<string, any> = {};

      questionsData.forEach(q => {
        if (q.type === 'checkboxes') {
          answers[q.id] = formData.getAll(q.id);
        } else {
          answers[q.id] = formData.get(q.id);
        }
      });

      // Store in sessionStorage
      sessionStorage.setItem('aiDiscoveryData', JSON.stringify({
        questions: questionsData,
        answers,
        answeredCount,
        totalQuestions: questionsData.length
      }));

      showSuccess('Discovery interview completed! Moving to feature selection...', { duration: 3000 });

      // Move to next step
      window.dispatchEvent(new CustomEvent('wizard:next'));
    });
  }

  // Previous button handler
  const prevButton = form?.querySelector('[data-action="previous"]');
  if (prevButton) {
    prevButton.addEventListener('click', () => {
      window.dispatchEvent(new CustomEvent('wizard:previous'));
    });
  }

  // Skip button handlers
  const skipButtons = document.querySelectorAll('[data-action="skip"]');
  skipButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      // Clear any existing discovery data
      sessionStorage.removeItem('aiDiscoveryData');
      showInfo('Skipped discovery interview. Moving to feature selection...', { duration: 2500 });
      window.dispatchEvent(new CustomEvent('wizard:next'));
    });
  });

  // Retry button handler
  if (retryBtn) {
    retryBtn.addEventListener('click', () => {
      generateQuestions();
    });
  }

  // Initialize when step becomes active
  let hasInitialized = false;

  // Listen for step activation
  window.addEventListener('step:2:active', () => {
    console.log('[Discovery] Step 2 activated');

    if (hasInitialized) {
      console.log('[Discovery] Already initialized, skipping');
      return;
    }

    hasInitialized = true;

    // Load saved data if exists
    const savedData = sessionStorage.getItem('aiDiscoveryData');
    if (savedData) {
      try {
        const data = JSON.parse(savedData);
        questionsData = data.questions;
        displayQuestions(data.questions, 'Previously answered questions');

        // Restore answers
        Object.entries(data.answers).forEach(([questionId, answer]) => {
          if (Array.isArray(answer)) {
            // Checkboxes
            answer.forEach((value: string) => {
              const checkbox = form?.querySelector(`input[name="${questionId}"][value="${value}"]`) as HTMLInputElement;
              if (checkbox) checkbox.checked = true;
            });
          } else if (answer) {
            const input = form?.querySelector(`[name="${questionId}"]`) as HTMLInputElement | HTMLTextAreaElement;
            if (input) {
              if (input.type === 'radio') {
                const radio = form?.querySelector(`input[name="${questionId}"][value="${answer}"]`) as HTMLInputElement;
                if (radio) radio.checked = true;
              } else {
                input.value = answer as string;
              }
            }
          }
        });

        updateProgress();

        // Hide loading, show form
        loadingState?.classList.add('hidden');
        form?.classList.remove('hidden');
      } catch (error) {
        console.error('[Discovery] Error loading saved data:', error);
        // If error loading saved data, generate new questions
        generateQuestions();
      }
    } else {
      // Generate questions on initial load
      generateQuestions();
    }
  });
</script>
